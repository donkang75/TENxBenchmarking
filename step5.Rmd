---
title: "Uncompressed HDF5 + Improvements"
output: html_document
---

Combining the modified versions of **rhdf5** and **DelayedArray**, with an uncompressed version of the counts table on disk.

```{r, setup, echo=FALSE, message=FALSE}
if(packageVersion('rhdf5') != "2.23.1.1") {
    devtools::install_github(repo = "grimbough/rhdf5", ref = "d12b2df", quiet = TRUE, force = TRUE)
}
if(packageVersion('DelayedArray') != "0.5.1.1") {
    devtools::install_github(repo = "grimbough/DelayedArray", ref = "d61695b",  quiet = TRUE, force = TRUE)
}
```

```{r, load-libs, message=FALSE}
library(TENxBrainData)
library(microbenchmark)
tenx <- TENxBrainData()
options(DelayedArray.block.size=2e9)
```

Create a new *SingleCellExperiment* object using the uncompressed HDF5Array as the counts table.

```{r, load-data}
h5.uncmp <- HDF5Array(file = '/tmpdata/msmith/tenx_uncompressed.h5', 
                      name = "counts")
tenx.uncmp <- SingleCellExperiment(
    list(counts = h5.uncmp), rowData = rowData(tenx), colData = colData(tenx)
)
tenx.sub.uncmp <- tenx.uncmp[,1:130000]
```

```{r, save-results}
systime <- system.time(res5 <- colSums(counts(tenx.sub.uncmp)))
save(res5, file = "res5.rda")
systime
```

```{r, uncompressed-tweaks}
bm5 <- microbenchmark(colSums(counts(tenx.sub.uncmp)),
                      times = 5L, unit = "s",
                      control = list(order = "block", warmup = 0))
bm5 <- rbind(data.frame(expr = "", time = as.numeric(systime[3]) * 1e9), bm5)

bm5$expr <- "rhdf5 &\nDelayedArray2"
save(bm5, file = "bm5.rda")
bm5
```
